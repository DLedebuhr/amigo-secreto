<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amigo Secreto - Edição Natalina</title>
    <style>
        /* Estilos originais (mantidos) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            /* Fundo com tema natalino (mantido) */
            background: 
                linear-gradient(rgba(10, 26, 21, 0.85), rgba(26, 44, 37, 0.9)),
                url('https://images.unsplash.com/photo-1512389142860-9c449e58a543?q=80&w=1469&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e8e6e3;
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden; /* Evita scroll horizontal na neve */
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            border-bottom: 1px solid rgba(184, 134, 11, 0.3);
        }
        
        .site-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: #b8860b;
            letter-spacing: 2px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; text-transform: uppercase; }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #fff;
            font-size: 1rem;
        }
        
        .form-input:focus { outline: none; border-color: #b8860b; }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: transparent;
            color: #b8860b;
            border: 1px solid #b8860b;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn:hover { background: rgba(184, 134, 11, 0.1); }
        .btn-primary { background: #b8860b; color: #000; font-weight: bold; border-color: #b8860b;}
        .btn-primary:hover { background: #d4af37; border-color: #d4af37; }
        
        .participant-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .link-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .link-box a { color: #98fb98; }
        
        .secret-name {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            color: #b8860b;
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            border: 1px dashed rgba(184, 134, 11, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .hidden { display: none; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: 4px; text-align: center; display: none; }
        .message-success { background: rgba(46, 139, 87, 0.2); color: #98fb98; }
        .message-error { background: rgba(178, 34, 34, 0.2); color: #ff6b6b; }

        /* Estilos para os flocos de neve (mantidos) */
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            font-size: 1em;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="snow-container"></div>
    
    <div class="container">
        <header class="header">
            <h1 class="site-title"><i class="fas fa-gift"></i> Amigo Secreto</h1>
        </header>
        
        <div id="message" class="message"></div>

        <div id="screen-create" class="card">
            <h2 style="margin-bottom: 20px; color: #fff;">Criar Novo Grupo</h2>
            <div class="form-group">
                <label class="form-label">Nome do Grupo</label>
                <input type="text" id="sorteio-nome" class="form-input" placeholder="Ex: Família Silva 2025">
            </div>
            <div class="form-group">
                <label class="form-label">Código de Acesso (sem espaços)</label>
                <input type="text" id="sorteio-codigo" class="form-input" placeholder="Ex: FAMILIA2025">
            </div>
            <button class="btn btn-primary" onclick="criarSorteio()">Começar</button>
        </div>
        
        <div id="screen-organizer" class="card hidden">
            <h2 style="margin-bottom: 20px; color: #b8860b;">Grupo: <span id="display-group-name"></span></h2>
            
            <div class="form-group">
                <label class="form-label">Nome do Participante</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="participante-nome" class="form-input" placeholder="Digite o nome...">
                    <button class="btn btn-primary" style="width: auto;" onclick="adicionarParticipante()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <h3 style="margin: 20px 0; border-bottom: 1px solid #333; padding-bottom: 10px;">
                Participantes (<span id="participant-count">0</span>)
            </h3>
            
            <div id="participant-list" style="margin-bottom: 30px;"></div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="realizarSorteioEGerarLinks()">
                    <i class="fas fa-random"></i> Sortear e Gerar Links
                </button>
                <button class="btn" onclick="inicio()">Sair</button>
            </div>
            
            <div id="links-container" class="hidden" style="margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">
                <h3 style="color: #98fb98; margin-bottom: 15px;">Sorteio Realizado!</h3>
                <p style="color: #ccc; margin-bottom: 15px;">Copie e envie o link para cada pessoa:</p>
                <div id="links-list"></div>
            </div>
        </div>
        
        <div id="screen-participant" class="card hidden">
            <div style="text-align: center;">
                <h2 style="color: #aaa;">Olá, <span id="part-name" style="color: #fff;"></span>!</h2>
                <p style="margin: 10px 0 30px 0;">Você está participando do sorteio: <strong id="sorteio-name"></strong></p>
                
                <div id="reveal-area">
                    <button class="btn btn-primary" onclick="revelarAmigo()">
                        <i class="fas fa-eye"></i> Ver Meu Amigo Secreto
                    </button>
                </div>
                
                <div id="result-area" class="hidden">
                    <p>Seu amigo secreto é:</p>
                    <div class="secret-name" id="secret-friend"></div>
                    <p style="font-size: 0.9rem; color: #888;">Tire um print ou memorize. Psiu, é segredo!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Use as suas chaves do Supabase
        const SUPABASE_URL = 'https://jpxeycjreinwseevmoen.supabase.co'; // SUBSTITUA PELA SUA URL REAL
        const SUPABASE_KEY = 'sb_publishable_9sSZQCTFdzvYQwO3l10HOA_Hu7PEaLe'; // SUBSTITUA PELA SUA CHAVE PUBLISHABLE REAL
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let estado = {
            sorteio: null,
            participantes: [],
            meuUsuario: null
        };

        // --- FUNÇÕES DE NAVEGAÇÃO E UI ---
        function mostrarMensagem(texto, tipo = 'success') {
            const el = document.getElementById('message');
            el.textContent = texto;
            el.className = `message message-${tipo}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function mostrarTela(id) {
            ['screen-create', 'screen-organizer', 'screen-participant'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }
        
        function inicio() { window.location.href = window.location.pathname; }

        // --- FUNÇÕES DO ORGANIZADOR ---
        async function criarSorteio() {
            const nome = document.getElementById('sorteio-nome').value.trim();
            const codigo = document.getElementById('sorteio-codigo').value.trim().toUpperCase();
            
            if (!nome || !codigo) return mostrarMensagem('Preencha todos os campos!', 'error');

            const { data, error } = await supabase
                .from('sorteios')
                .insert([{ nome, codigo }])
                .select()
                .single();

            if (error) return mostrarMensagem('Erro ao criar: Código já existe ou falha na conexão. ' + error.message, 'error');

            estado.sorteio = data;
            document.getElementById('display-group-name').textContent = nome;
            mostrarTela('screen-organizer');
        }

        async function adicionarParticipante() {
            const input = document.getElementById('participante-nome');
            const nome = input.value.trim();
            if (!nome) return;

            // CORREÇÃO: Inserção alinhada com as colunas do SQL
            const { data, error } = await supabase
                .from('participantes')
                .insert([{
                    sorteio_id: estado.sorteio.id,
                    nome: nome,
                    // Colunas que existem no SQL:
                    ja_vizualizou: false, 
                    amigo_secreto_id: null,
                    codigo_pessoal: Math.random().toString(36).substring(2, 12)
                }])
                .select()
                .single();

            if (error) return mostrarMensagem('Erro ao adicionar: ' + error.message, 'error');

            input.value = '';
            carregarListaParticipantes();
            mostrarMensagem(`${nome} adicionado!`);
        }

        async function carregarListaParticipantes() {
            const { data } = await supabase
                .from('participantes')
                .select('*')
                .eq('sorteio_id', estado.sorteio.id)
                .order('nome');
            
            estado.participantes = data || [];
            
            const lista = document.getElementById('participant-list');
            lista.innerHTML = '';
            document.getElementById('participant-count').textContent = estado.participantes.length;

            estado.participantes.forEach(p => {
                lista.innerHTML += `
                    <div class="participant-item">
                        <span>${p.nome}</span>
                        <span style="color: #aaa; font-size: 0.8rem;">${p.amigo_secreto_id ? 'Já sorteado' : 'Aguardando'}</span>
                    </div>`;
            });
        }

        async function realizarSorteioEGerarLinks() {
            if (estado.participantes.length < 2) return mostrarMensagem('Precisa de pelo menos 2 pessoas!', 'error');

            // Algoritmo de Sorteio (Fisher-Yates Shuffle para garantir aleatoriedade)
            let pool = [...estado.participantes];
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }

            // Atualizar no banco (Ciclo fechado: 0 tira 1, 1 tira 2...)
            try {
                for (let i = 0; i < pool.length; i++) {
                    const quemTira = pool[i];
                    const quemRecebe = pool[(i + 1) % pool.length];

                    await supabase
                        .from('participantes')
                        .update({ amigo_secreto_id: quemRecebe.id })
                        .eq('id', quemTira.id);
                }
                
                // Recarregar dados e mostrar links
                await carregarListaParticipantes();
                exibirLinks();
                mostrarMensagem('Sorteio realizado com sucesso!');
                
            } catch (err) {
                mostrarMensagem('Erro no sorteio: ' + err.message, 'error');
            }
        }

        function exibirLinks() {
            const container = document.getElementById('links-list');
            container.innerHTML = '';
            document.getElementById('links-container').classList.remove('hidden');
            
            const baseUrl = window.location.href.split('?')[0];

            estado.participantes.forEach(p => {
                const link = `${baseUrl}?k=${p.codigo_pessoal}`;
                container.innerHTML += `
                    <div class="link-box">
                        <strong style="color:#fff">${p.nome}</strong><br>
                        <a href="${link}" target="_blank">${link}</a>
                    </div>`;
            });
        }

        // --- FUNÇÕES DO PARTICIPANTE ---
        async function carregarTelaParticipante(codigo) {
            // Busca dados do participante + dados do sorteio (join)
            const { data, error } = await supabase
                .from('participantes')
                .select('*, sorteios(*)')
                .eq('codigo_pessoal', codigo)
                .single();

            if (error || !data) return mostrarMensagem('Link inválido ou expirado.', 'error');

            estado.meuUsuario = data;
            
            document.getElementById('part-name').textContent = data.nome;
            document.getElementById('sorteio-name').textContent = data.sorteios.nome;
            mostrarTela('screen-participant');

            // Se já visualizou antes, já mostra direto
            if (data.ja_vizualizou && data.amigo_secreto_id) {
                buscarAmigoSecreto();
            }
        }

        async function revelarAmigo() {
            if (!estado.meuUsuario.amigo_secreto_id) {
                return mostrarMensagem('O organizador ainda não realizou o sorteio!', 'error');
            }
            
            // Marca como visualizado no banco
            await supabase.from('participantes')
                .update({ ja_vizualizou: true })
                .eq('id', estado.meuUsuario.id);

            buscarAmigoSecreto();
        }

        async function buscarAmigoSecreto() {
            const { data } = await supabase
                .from('participantes')
                .select('nome')
                .eq('id', estado.meuUsuario.amigo_secreto_id)
                .single();

            if (data) {
                document.getElementById('reveal-area').classList.add('hidden');
                document.getElementById('result-area').classList.remove('hidden');
                document.getElementById('secret-friend').textContent = data.nome;
            }
        }

        // --- FUNÇÕES DE ANIMAÇÃO (MANTIDAS) ---
        function createSnowflakes() {
            const container = document.getElementById('snow-container');
            for (let i = 0; i < 50; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.innerHTML = '&#10052;'; // Símbolo de floco de neve
                flake.style.left = `${Math.random() * 100}%`;
                flake.style.fontSize = `${Math.random() * 1 + 0.8}em`;
                
                // Animação simples via JS para não complicar CSS
                animateSnowflake(flake);
                
                container.appendChild(flake);
            }
        }
        
        function animateSnowflake(flake) {
            let top = -10;
            const speed = Math.random() * 1 + 0.5;
            
            function fall() {
                top += speed;
                if (top > window.innerHeight) {
                    top = -10;
                    flake.style.left = `${Math.random() * 100}%`;
                }
                flake.style.top = `${top}px`;
                requestAnimationFrame(fall);
            }
            requestAnimationFrame(fall); // Começa a animação
        }

        // --- INICIALIZAÇÃO ---
        window.onload = function() {
            createSnowflakes();
            
            // Verifica se tem parâmetro na URL (?k=CODIGO)
            const urlParams = new URLSearchParams(window.location.search);
            const codigoLink = urlParams.get('k');
            
            if (codigoLink) {
                carregarTelaParticipante(codigoLink);
            } else {
                mostrarTela('screen-create');
            }
        };
    </script>
</body>
</html>
